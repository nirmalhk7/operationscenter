# --- CSP Script-src Mapping ---
map $server_name $script_src {
    default "'self'";
    immich.trusted.nirmalhk7.com "'self' 'unsafe-inline' 'unsafe-eval' https://tiles.immich.cloud";
}

# --- CSP Style-src Mapping ---
map $server_name $style_src {
    default "'self' 'unsafe-inline'";
    immich.trusted.nirmalhk7.com "'self' 'unsafe-inline' https://tiles.immich.cloud";
}

# --- CSP Img-src Mapping ---
map $server_name $img_src {
    default "'self' data: https://cdn.jsdelivr.net https://images.unsplash.com";
    immich.trusted.nirmalhk7.com "'self' data: https://cdn.jsdelivr.net https://images.unsplash.com https://tiles.immich.cloud";
}

# --- Security Headers ---
add_header X-Content-Type-Options nosniff;
add_header X-Frame-Options DENY;
add_header X-XSS-Protection "1; mode=block";
add_header Referrer-Policy "no-referrer-when-downgrade";
add_header Content-Security-Policy "default-src 'self'; script-src $script_src; object-src 'none'; style-src $style_src; img-src $img_src; font-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'";

add_header Set-Cookie "secure; HttpOnly; SameSite=Strict" always;
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()";
add_header Cross-Origin-Resource-Policy "same-origin";
add_header Cross-Origin-Opener-Policy "same-origin";
add_header Cross-Origin-Embedder-Policy "require-corp";

# --- Miscellaneous ---
server_tokens off;

# --- Logging ---
# access_log /var/log/nginx/mgd_access.log main;
# error_log /var/log/nginx/mgd_error.log warn;

# --- Proxy Headers ---
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;

# --- WebSocket Support ---
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";
# proxy_set_header Connection $connection_upgrade_keepalive;

# --- Request Size & Buffer Limits ---
client_max_body_size 2M;
client_body_buffer_size 16K;
client_header_buffer_size 1k;
large_client_header_buffers 2 2k;

# --- Timeout Settings ---
proxy_read_timeout 30s; 
proxy_connect_timeout 30s; 

# --- DNS Resolver ---
resolver 1.1.1.1 1.0.0.1 valid=300s;
resolver_timeout 5s;

# --- Error Handling ---
error_page 504 /timeout.html;
location = /timeout.html {
    internal;
    return 408 "Oops, our servers took a nap. Try poking us again!";
}

error_page 502 /badgateway.html;
location = /badgateway.html {
    internal;
    return 502 "Bad Gateway: Our hamsters are on a coffee break. Try again in a bit!";
}

# --- User Agent Filtering ---
if ($http_user_agent ~* (nikto|sqlmap|fimap|nmap|nessus|dirbuster|acunetix|netsparker|curl|wget|libwww|python|scan|bot|crawler|spider|scrapy|masscan|hydra|john|havij|paros|burp|zaproxy|rat|brutus|webinspect|sqlninja|w3af|metasploit|coreimpact|canvas|beef|sqlsus|sqlbrute|sqlb|gpt|openai|chatgpt|bard|gemini|llama|anthropic|claude|copilot|ai|deepmind|bingbot|googlebot|yandexbot|baiduspider|sogou|exabot|facebot|ia_archiver)
) {
    return 403 "Bots detected! Please prove you're not a toaster.";
}

# --- Access Control ---
location ~* /(\.|backup|bak|\.git|\.svn|\.env|\.DS_Store|\.htaccess|\.htpasswd|\.log|\.pem|\.key|\.crt|\.zip|\.tar|\.gz|\.tgz|\.bz2|\.7z|\.rar)$ {
    deny all;
    return 472 "Nice try, secret agent. Hidden files are for our eyes only!";
}

# Enforce HTTPS
# Uncomment for authentik
if ($scheme = http) {
    return 301 https://$host$request_uri;
}

# Method restrictions based on server_name
map $request_method:$server_name $method_allowed {
    # Basic methods allowed everywhere
    ~^(GET|POST):.* 1;
    
    # DELETE only for Immich
    DELETE:immich.trusted.nirmalhk7.com 1;
    
    # WebDAV methods only for Drive
    PROPFIND:drive.trusted.nirmalhk7.com 1;
    REPORT:drive.trusted.nirmalhk7.com 1;
    PATCH:drive.trusted.nirmalhk7.com 1;
    SEARCH:drive.trusted.nirmalhk7.com 1;
    MKCOL:drive.trusted.nirmalhk7.com 1;
    
    # Default deny
    default 0;
}

# Apply method restrictions
if ($method_allowed = 0) {
    return 471 "Request denied. That method is as welcome as pineapple on pizza.";
}