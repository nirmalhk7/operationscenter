# --- Security Headers ---
add_header X-Content-Type-Options nosniff;
add_header X-Frame-Options DENY;
add_header X-XSS-Protection "1; mode=block";
add_header Referrer-Policy "no-referrer-when-downgrade";
add_header Content-Security-Policy "default-src 'self'; script-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'";
add_header Set-Cookie "secure; HttpOnly; SameSite=Strict" always;

# --- Miscellaneous ---
server_tokens off;

# --- Logging ---
# access_log /var/log/nginx/mgd_access.log main;
# error_log /var/log/nginx/mgd_error.log warn;

# --- Proxy Headers ---
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;

# --- WebSocket Support ---
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";

# --- Connection & Request Limits ---
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:100m;
limit_conn zone=conn_limit_per_ip 100;
limit_req_zone $binary_remote_addr zone=req_limit:100m rate=50r/s;
limit_req zone=req_limit burst=100 nodelay;

# --- Request Size & Buffer Limits ---
client_max_body_size 2M;
client_body_buffer_size 16K;
client_header_buffer_size 1k;
large_client_header_buffers 2 2k;

# --- Timeout Settings ---
proxy_read_timeout 30s; 
proxy_connect_timeout 30s; 

# --- DNS Resolver ---
resolver 1.1.1.1 1.0.0.1 valid=300s;
resolver_timeout 5s;

# --- Error Handling ---
error_page 504 /timeout.html;
location = /timeout.html {
    internal;
    return 408 "Oops, our servers took a nap. Try poking us again!";
}

# --- User Agent Filtering ---
if ($http_user_agent ~* (nikto|sqlmap|fimap|nmap|nessus|dirbuster|acunetix|netsparker|curl|wget|libwww|python|scan|bot|crawler|spider|scrapy|masscan|hydra|john|havij|paros|burp|zaproxy|rat|brutus|webinspect|sqlninja|w3af|metasploit|coreimpact|canvas|beef|sqlsus|sqlbrute|sqlb|gpt|openai|chatgpt|bard|gemini|llama|anthropic|claude|copilot|ai|deepmind|bingbot|googlebot|yandexbot|baiduspider|sogou|exabot|facebot|ia_archiver)
) {
    return 403 "Bots detected! Please prove you're not a toaster.";
}

# --- Access Control ---
# Block access to hidden files and sensitive paths
location ~* /(\.|backup|bak|\.git|\.svn|\.env|\.DS_Store|\.htaccess|\.htpasswd|\.log|\.pem|\.key|\.crt|\.zip|\.tar|\.gz|\.tgz|\.bz2|\.7z|\.rar)$ {
    deny all;
    return 404 "Nice try, secret agent. Hidden files are for our eyes only!";
}

# Enforce HTTPS
if ($scheme = http) {
    return 301 https://$host$request_uri;
}

# Limit request methods
if ($request_method !~ ^(GET|POST|HEAD)$) {
    return 444 "Request denied. That method is as welcome as pineapple on pizza.";
}