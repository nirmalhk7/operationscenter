---
- name: Operations Center Host Setup
  hosts: proxmox
  become: true
  vars:
    homelab_path: /root/operationscenter
    # Network Configuration
    host_ip: "10.0.0.10"
    int_subnet: "172.16.0.0/24"
    nginx_ip: "172.16.0.101"
    k8s_ip: "172.16.0.105"
    nfs_ip: "172.16.0.108"
    vpn_ip: "100.87.0.43"
    wan_iface: "wlp4s0"
    lan_iface: "wmnet"
    vpn_iface: "tailscale0"
    tailscale_auth_key: "{{ lookup('env', 'TAILSCALE_AUTHKEY') | default('', true) }}"
    # SSH Key for passwordless auth (ed25519)
    ssh_pubkey_ed25519: "{{ lookup('file', '~/.ssh/id_ed25519_homelab.pub') }}"

  tasks:
    - name: SSH hardening for Proxmox host
      tags: ssh
      block:
        - name: Deploy ed25519 public key to Proxmox host
          ansible.posix.authorized_key:
            user: root
            key: "{{ ssh_pubkey_ed25519 }}"
            state: present
            exclusive: false

        - name: Harden SSH configuration on Proxmox host
          ansible.builtin.lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
            state: present
            backup: true
          loop:
            - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin prohibit-password' }
            - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
            - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
            - { regexp: '^#?AllowAgentForwarding', line: 'AllowAgentForwarding yes' }
            - { regexp: '^#?ChallengeResponseAuthentication', line: 'ChallengeResponseAuthentication no' }
          notify: Restart SSH

    - name: Networking configuration
      tags: hostconf
      block:
        - name: Create operations center networking directory
          ansible.builtin.file:
            path: "{{ homelab_path }}/networking"
            state: directory
            mode: '0755'

        - name: Download iptables-up.sh script
          ansible.builtin.get_url:
            url: "https://raw.githubusercontent.com/nirmalhk7/operationscenter/refs/heads/main/infrastructure/assets/iptables-up.sh"
            dest: "{{ homelab_path }}/networking/iptables-up.sh"
            mode: '0755'

        - name: Download iptables-down.sh script
          ansible.builtin.get_url:
            url: "https://raw.githubusercontent.com/nirmalhk7/operationscenter/refs/heads/main/infrastructure/assets/iptables-down.sh"
            dest: "{{ homelab_path }}/networking/iptables-down.sh"
            mode: '0755'

        - name: Configure wmnet bridge interface
          ansible.builtin.blockinfile:
            path: /etc/network/interfaces
            marker: "# {mark} ANSIBLE MANAGED - wmnet bridge"
            block: |
              auto wmnet
              iface wmnet inet static
                  address 172.16.0.1/24
                  bridge-ports none
                  bridge-stp off
                  bridge-fd 0
                  post-up {{ homelab_path }}/networking/iptables-up.sh
                  post-down {{ homelab_path }}/networking/iptables-down.sh

    - name: Single node Proxmox configuration
      tags: singlenode
      block:
        - name: Disable HA services (not needed for single node)
          ansible.builtin.systemd:
            name: "{{ item }}"
            state: stopped
            enabled: false
          loop:
            - pve-ha-lrm
            - pve-ha-crm
            - corosync

        - name: Disable enterprise repository (unless subscribed)
          ansible.builtin.file:
            path: /etc/apt/sources.list.d/pve-enterprise.list
            state: absent

        - name: Add Proxmox no-subscription repository
          ansible.builtin.apt_repository:
            repo: "deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription"
            filename: pve-no-subscription
            state: present

    - name: Tailscale setup on Proxmox host
      tags:
      - networking
      - tailscale
      block:
        - name: Check if Tailscale is installed
          ansible.builtin.stat:
            path: /usr/bin/tailscale
          register: tailscale_bin

        - name: Install Tailscale when missing
          ansible.builtin.shell: curl -fsSL https://tailscale.com/install.sh | sh
          args:
            warn: false
          when: not tailscale_bin.stat.exists

        - name: Ensure tailscaled service enabled and running
          ansible.builtin.systemd:
            name: tailscaled
            enabled: true
            state: started

        - name: Enable IPv4 forwarding for Tailscale
          ansible.posix.sysctl:
            name: net.ipv4.ip_forward
            value: '1'
            state: present
            reload: true

        - name: Check Tailscale status
          ansible.builtin.command: tailscale status --peers=false
          register: tailscale_status
          failed_when: false
          changed_when: false

        - name: Fail if auth key missing when login required
          ansible.builtin.fail:
            msg: "TAILSCALE_AUTHKEY env var required to bring Tailscale up"
          when: (tailscale_status.rc != 0) and (tailscale_auth_key | length == 0)

        - name: Bring Tailscale up when not connected
          ansible.builtin.command: tailscale up --auth-key={{ tailscale_auth_key }}
          when: tailscale_status.rc != 0

  handlers:
    - name: Restart SSH
      ansible.builtin.systemd:
        name: sshd
        state: restarted
